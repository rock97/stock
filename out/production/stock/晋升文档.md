# 佣金灵活配置
## 业务背景
- 业务介绍一下
## 技术挑战
- 佣金规则复杂 列出配置条件
- 佣金类型多 列出有几种佣金规则
- 佣金变化多 列出最近几次的需求变化 巴西佣金规则变更，2023-Q4巴西佣金规则变更，代运营全托管商家不收取佣金，2024Q1佣金变更，新手村-平台佣金政策，二店佣金政策，3P商家佣金调整，2025年1月1日商家佣金政策调整
，平台佣金封顶
- 扩展性差 新增佣金类型需要重写一套代码
- 上线容易出bug 列出最近几次上线bug
## 定策略
- 针对佣金规则复杂->模型标准化
- 针对业务类型多->模型标准化
- 针对变化多->配置化 
- 针对上线容易出Bug->灰度发布
## 业务梳理
- 1.匹配规则拆解->先拆散
- 2.归纳分析->找共同点
- 3.聚合抽象->模型
- 4.上大招->规则引擎
- 5.流程标准化
- 6.补充一个新业务接入时候的场景
## 灰度发布 & 告警监控
# 结算架构升级
## 业务背景
## 技术挑战
- 结算时间长
- 结算失败
## 问题分析
- 用户冗余大 发现问题的过程流程写一下
- 数据量大导致数据库连接超时
1. 结算周期过长：目前的结算流程是通过定时任务触发，每周一汇总上周的费项明细，并按账户维度计算金额后划拨至对应账户。由于账户数量庞大，已达到100万之多，导致每次结算任务的执行时间都超过4小时。这种长周期的结算不仅效率低下，还可能对系统稳定性造成一定影响。
2. 结算失败问题：在结算过程中，接口每次处理一个账户整个结算周期的所有费项明细。对于头部商家而言，每周订单量可达2000多单，费项明细接近2万条。如此庞大的数据量使得在将结算单更新回费项明细时，极易导致数据库连接超时，进而引发结算失败的情况。这不仅影响了商家的体验，也可能对我们的业务流程造成阻碍。
## 定策略
- 用户冗余大->数据集聚焦 只处理需要处理的部分
- 数据量大导致数据库连接超时-> 预处理+任务拆解（预结算，结算）
## 业务梳理
- 复杂问题如何分析的->二维矩阵分析法 做到不重不漏
- 处理时间较长：分批次，一次计算一段时间内的。分步骤，将结算分解为预创建、算金额、异常处理、结算四大步。分批次，一次一批
## 如何保证数据安全
- 幂等设计
- 金额校验兜底逻辑

# 资金安全与稳定性
## 一、资金安全
### 事前
- 代码&配置变更2人以上CR
- 资损相关上线全流程全场景回归测试
- 资损演练
- 一键防资损建设
- 全链路对账
### 事中
- 数据唯一性保证
- 外部接口交互幂等校验
- 重试幂等校验
- 一键停止结算 or 打款
- 账户冻结
- 资金异常拦截
- 风控拦截
- 结算周期重叠，遗漏校验
### 事后
- 撤销（发票、账单、结算单、分账单、调账单、清分）
- 重算（发票、账单、结算单、分账单、调账单、清分）
- 对账发现问题
- 调账
- 监控告警
- 资金异常告警（资金掉零，资金变化幅度过大）
# 五.未来规划
## 1.存储架构升级
## 2.对账完成后才能结算打款
## 3.佣金配置细化（阶梯佣金，激励，特殊商品佣金等）